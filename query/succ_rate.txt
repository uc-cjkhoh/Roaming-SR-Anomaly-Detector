select dt, success_count / (fail_count + success_count) as success_rate from ( select dt, sum(fail_count) as fail_count, sum(success_count) as success_count from ( select dt, case when tx_status = 'Fail' Then count else 0 end as fail_count, case when tx_status = 'Success' then count else 0 end as success_count from ( select     dt,     tx_status,     count(1) as count from     (         select 			case 				when 1 = 1 THEN 					concat(tx_date, ' ', right(concat('0', cast(tx_hour as string)), 2)) 				when 1 = 2 THEN 					tx_date 				when 1 = 4 THEN 					left(tx_date, 7) 				when 1 = 5 THEN	    					concat ( 						tx_date, 						' ', 						right (concat ('0', cast(tx_hour as string)), 2), 						':', 						right (concat ('0', cast(tx_qh as string)), 2), 						':00' 					) 			end as dt,             if (mcc_ref_primary > 0, mcc_ref_primary, mcc_ref) as mcc,             IF (mnc_ref_primary != '', mnc_ref_primary, mnc_ref) AS mnc,             IF (                 status_type = 12                 and (`status` in ('1', '2', '3', '4', '5')),                 'Success',                 'Fail'             ) as tx_status         from             roam350_report_m1.data_em         where             (par_date between 20230401 and 20230521)             and op_code IN (2, 23, 316)             and par_bound_type = 2             and rat_type = 1004     ) tbl where     mcc = 502 group by     dt,     tx_status ) tbl ) tbl group by dt ) tbl